-- GLM-4 AI é…ç½®æ¨¡å— - åŸºäº avante.nvim å®˜æ–¹è§„èŒƒ
-- ä½¿ç”¨ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ç®¡ç† GLM-4 è®¾ç½®

return {
  -- ä¸»æ’ä»¶é…ç½®
  {
    "yetone/avante.nvim",
    event = "VeryLazy",
    build = "make", -- å¦‚æœéœ€è¦æ„å»º
    dependencies = {
      "nvim-tree/nvim-web-devicons", -- å›¾æ ‡æ”¯æŒ
      "nvim-lua/plenary.nvim",       -- å·¥å…·å‡½æ•°
      "MunifTanjim/nui.nvim",        -- UIç»„ä»¶
    },
    
    opts = function()
      -- åŠ è½½ GLM-4 é…ç½®
      local glm4_config = require("config.glm4-config")
      
      -- è®¾ç½®ç¯å¢ƒå˜é‡
      glm4_config.setup_environment()
      
      -- è¿”å› avante é…ç½®
      return glm4_config.get_avante_config()
    end,
    
    -- é”®ä½é…ç½®
    keys = {
      { "<leader>ia", "<cmd>AvanteAsk<cr>", desc = "GLM-4 è¯¢é—®" },
      { "<leader>ie", "<cmd>AvanteEdit<cr>", desc = "GLM-4 ç¼–è¾‘" },
      { "<leader>ir", "<cmd>AvanteRefresh<cr>", desc = "GLM-4 åˆ·æ–°" },
      { "<leader>is", "<cmd>AvanteStop<cr>", desc = "GLM-4 åœæ­¢" },
      { "<leader>im", "<cmd>AvanteSwitchProvider<cr>", desc = "GLM-4 åˆ‡æ¢æä¾›å•†" },
    },
    
    config = function(_, opts)
      -- åˆå§‹åŒ– avante
      require("avante").setup(opts)
      
      -- åˆ›å»º GLM-4 ä¸“ç”¨å‘½ä»¤
      vim.api.nvim_create_user_command("GLM4Chat", function(input_opts)
        require("avante.api").ask(input_opts.args)
      end, { nargs = "*", desc = "GLM-4 å¯¹è¯" })
      
      vim.api.nvim_create_user_command("GLM4Explain", function()
        local filetype = vim.bo.filetype
        local question = "è¯·è¯¦ç»†è§£é‡Šè¿™æ®µ " .. filetype .. " ä»£ç çš„åŠŸèƒ½å’Œå®ç°åŸç†"
        require("avante.api").ask(question)
      end, { desc = "GLM-4 è§£é‡Šä»£ç " })
      
      vim.api.nvim_create_user_command("GLM4Optimize", function()
        local filetype = vim.bo.filetype
        local question = "è¯·ä¼˜åŒ–è¿™æ®µ " .. filetype .. " ä»£ç ï¼Œæé«˜æ€§èƒ½å’Œå¯è¯»æ€§"
        require("avante.api").ask(question)
      end, { desc = "GLM-4 ä¼˜åŒ–ä»£ç " })
      
      -- çŠ¶æ€æ é›†æˆ
      vim.g.glm4_status = "GLM-4 Ready"
      vim.api.nvim_create_autocmd("User", {
        pattern = "AvanteRequestStart",
        callback = function()
          vim.g.glm4_status = "GLM-4 Thinking..."
        end,
      })
      
      vim.api.nvim_create_autocmd("User", {
        pattern = "AvanteRequestComplete",
        callback = function()
          vim.g.glm4_status = "GLM-4 Ready"
        end,
      })
      
     
    end,
  },
  
  -- GLM-4 å·¥å…·æ¨¡å—
  {
    "nvim-lua/plenary.nvim",
    config = function()
      -- åŠ è½½é…ç½®æ¨¡å—
      local glm4_config = require("config.glm4-config")
      
      -- GLM-4 å·¥å…·å‡½æ•°
      local glm4_utils = {}
      
      --- è·å–å½“å‰é…ç½®
      function glm4_utils.get_config()
        return glm4_config
      end
      
      --- åˆ‡æ¢æ¨¡å‹
      function glm4_utils.switch_model(model)
        local valid_models = glm4_config.available_models
        local found = false
        
        for _, m in ipairs(valid_models) do
          if m == model then
            found = true
            break
          end
        end
        
        if not found then
          vim.notify("æ— æ•ˆçš„æ¨¡å‹: " .. model, vim.log.levels.ERROR)
          return
        end
        
        -- æ›´æ–° avante é…ç½®
        local ok, avante = pcall(require, "avante")
        if ok and avante.get_config then
          local config = avante.get_config()
          if config.providers and config.providers.glm4 then
            config.providers.glm4.model = model
            avante.setup(config)
            vim.notify("GLM-4 æ¨¡å‹å·²åˆ‡æ¢åˆ°: " .. model, vim.log.levels.INFO)
          end
        end
      end
      
      --- è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
      function glm4_utils.get_models()
        return glm4_config.available_models
      end
      
      --- æµ‹è¯•è¿æ¥
      function glm4_utils.test_connection()
        local valid, message = glm4_config.validate_api_key()
        if not valid then
          vim.notify("GLM-4 é…ç½®é”™è¯¯: " .. message, vim.log.levels.ERROR)
          return
        end
        
        vim.notify("æ­£åœ¨æµ‹è¯• GLM-4 è¿æ¥...", vim.log.levels.INFO)
        require("avante.api").ask("ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªè¿æ¥æµ‹è¯•ã€‚è¯·å›å¤\"è¿æ¥æˆåŠŸ\"ã€‚")
      end
      
      --- è·å–æ¨¡å‹ä¿¡æ¯
      function glm4_utils.get_model_info(model)
        return glm4_config.get_model_info(model)
      end
      
      --- æ˜¾ç¤ºå½“å‰çŠ¶æ€
      function glm4_utils.show_status()
        local glm4_module = require("config.glm4-config")
        local status = {
          "GLM-4 çŠ¶æ€ä¿¡æ¯:",
          "  æä¾›å•†: " .. (vim.g.avante_provider or "glm4"),
          "  æ¨¡å‹: " .. glm4_module.api_config.model,
          "  APIç«¯ç‚¹: " .. glm4_module.api_config.endpoint,
          "  çŠ¶æ€: " .. (vim.g.glm4_status or "Unknown"),
        }
        
        vim.notify(table.concat(status, "\n"), vim.log.levels.INFO)
      end
      
      -- å¯¼å‡ºåˆ°å…¨å±€
      _G.glm4 = glm4_utils
      
      -- åˆ›å»ºç”¨æˆ·å‘½ä»¤
      vim.api.nvim_create_user_command("GLM4Test", function()
        glm4_utils.test_connection()
      end, { desc = "æµ‹è¯• GLM-4 è¿æ¥" })
      
      vim.api.nvim_create_user_command("GLM4SwitchModel", function(opts)
        local model = opts.args ~= "" and opts.args or "glm-4-flash"
        glm4_utils.switch_model(model)
      end, { nargs = "?", desc = "åˆ‡æ¢ GLM-4 æ¨¡å‹" })
      
      vim.api.nvim_create_user_command("GLM4Models", function()
        local models = glm4_utils.get_models()
        local info = { "å¯ç”¨ GLM-4 æ¨¡å‹:" }
        for _, model in ipairs(models) do
          local model_info = glm4_utils.get_model_info(model)
          table.insert(info, string.format("  %s - %s", model, model_info.description))
        end
        vim.notify(table.concat(info, "\n"), vim.log.levels.INFO)
      end, { desc = "æ˜¾ç¤ºå¯ç”¨ GLM-4 æ¨¡å‹" })
      
      vim.api.nvim_create_user_command("GLM4Status", function()
        glm4_utils.show_status()
      end, { desc = "æ˜¾ç¤º GLM-4 çŠ¶æ€" })
      
      -- é¢å¤–çš„å¿«æ·é”®
      vim.keymap.set("n", "<leader>it", "<cmd>GLM4Test<cr>", { desc = "æµ‹è¯• GLM-4 è¿æ¥" })
      vim.keymap.set("n", "<leader>im", "<cmd>GLM4SwitchModel ", { desc = "åˆ‡æ¢ GLM-4 æ¨¡å‹" })
      vim.keymap.set("n", "<leader>iM", "<cmd>GLM4Models<cr>", { desc = "æ˜¾ç¤º GLM-4 æ¨¡å‹" })
      vim.keymap.set("n", "<leader>is", "<cmd>GLM4Status<cr>", { desc = "æ˜¾ç¤º GLM-4 çŠ¶æ€" })
    end,
  },
  
  -- çŠ¶æ€æ é›†æˆ
  {
    "nvim-lualine/lualine.nvim",
    optional = true,
    config = function()
      if not package.loaded.lualine then
        return
      end
      
      local function glm4_status()
        local avante_loaded, avante = pcall(require, "avante")
        if avante_loaded and avante.get_config then
          local config = avante.get_config()
          if config and config.provider == "glm4" then
            local status = vim.g.glm4_status or "GLM-4 Ready"
            return "ğŸ¤– " .. status
          end
        end
        return ""
      end
      
      -- å®‰å…¨åœ°æ›´æ–° lualine é…ç½®
      local ok, lualine = pcall(require, "lualine")
      if ok then
        local config = lualine.get_config()
        if config and config.sections and config.sections.lualine_x then
          -- ç¡®ä¿ä¸é‡å¤æ·»åŠ 
          local found = false
          for _, component in ipairs(config.sections.lualine_x) do
            if type(component) == "function" and component() and component():match("ğŸ¤–") then
              found = true
              break
            end
          end
          
          if not found then
            table.insert(config.sections.lualine_x, 1, glm4_status)
            lualine.setup(config)
          end
        end
      end
    end,
  },
}