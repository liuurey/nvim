---
-- é›ªå¾‹ TIFA âˆ å†»ç»“ç‰ˆ llm.nvim é…ç½®
-- ä¾èµ–ç¯å¢ƒå˜é‡ï¼šZHIPU_API_KEY ï¼ˆWindows11 ä¸‹è®¾ç½®ä¸ºç³»ç»Ÿå˜é‡ï¼‰
-- ç»Ÿä¸€åœ¨ i æ¨¡å¼åŠ ä¸­æ–‡ descï¼Œæ–¹ä¾¿ç§’æ‡‚
-- æ¨¡å‹ï¼šglm-4-flashï¼ˆæ™ºè°±æ¸…è¨€å…è´¹é«˜é€Ÿç‰ˆï¼‰
---
return {
  "Kurama622/llm.nvim",
  dependencies = {
    { "nvim-lua/plenary.nvim",  lazy = true },
    { "MunifTanjim/nui.nvim",   lazy = true },
  },
  cmd = { "LLMSessionToggle", "LLMSelectedTextHandler", "LLMAppHandler" },
  keys = {
    -- ç»Ÿä¸€æ”¶æ‹¢åˆ° <leader>i å‰ç¼€ï¼Œæ–¹ä¾¿è®°å¿†ä¸é¿å…å†²çª
    { "<leader>ic", mode = { "n" }, "<cmd>LLMSessionToggle<cr>", desc = "å¼€å…³ LLM èŠå¤©çª—" },
    { "<leader>it", mode = { "x" }, "<cmd>LLMAppHandler WordTranslate<cr>", desc = "åˆ’è¯ç¿»è¯‘" },
    { "<leader>ie", mode = { "x" }, "<cmd>LLMAppHandler CodeExplain<cr>", desc = "è§£é‡Šä»£ç " },
    { "<leader>ia", mode = { "n" }, "<cmd>LLMAppHandler Translate<cr>", desc = "AI ç¿»è¯‘æ•´æ®µ" },
    { "<leader>iT", mode = { "x" }, "<cmd>LLMAppHandler TestCode<cr>", desc = "ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹" },
    { "<leader>io", mode = { "x" }, "<cmd>LLMAppHandler OptimCompare<cr>", desc = "ä¼˜åŒ–ä»£ç å¹¶å¯¹æ¯”" },
    { "<leader>iu", mode = { "n" }, "<cmd>LLMAppHandler UserInfo<cr>", desc = "æŸ¥è¯¢è´¦æˆ·ä½™é¢" },
    { "<leader>ig", mode = { "n" }, "<cmd>LLMAppHandler CommitMsg<cr>", desc = "ç”Ÿæˆæäº¤ä¿¡æ¯" },
    { "<leader>id", mode = { "x" }, "<cmd>LLMAppHandler DocString<cr>", desc = "ç”Ÿæˆæ–‡æ¡£å­—ç¬¦ä¸²" },
    { "<leader>ik", mode = { "x", "n" }, "<cmd>LLMAppHandler Ask<cr>", desc = "ä¸€æ¬¡æ€§æé—®" },
    { "<leader>im", mode = { "x", "n" }, "<cmd>LLMAppHandler AttachToChat<cr>", desc = "å¤šè½®è¿½é—®" },
  },
  config = function()
    require("llm").setup({
      -- æ™ºè°±æ¸…è¨€å®˜æ–¹æ¥å£
      url     = "https://open.bigmodel.cn/api/paas/v4/chat/completions",
      model   = "glm-4-flash",
      api_type= "zhipu",
      -- ä»ç¯å¢ƒå˜é‡è¯»å–å¯†é’¥ï¼ŒWindows11 æ¨èåœ¨ã€Œç³»ç»Ÿå˜é‡ã€é‡Œæ–°å¢ ZHIPU_API_KEY
      fetch_key = function() return vim.fn.getenv("ZHIPU_API_KEY") end,
      timeout = 30,                    -- 30 ç§’è¶…æ—¶
      max_tokens = 4096,               -- æœ€å¤§è¿”å›é•¿åº¦
      temperature = 0.7,                 -- åˆ›é€ åŠ› 0~1
      top_p = 0.9,                     -- å¤šæ ·æ€§ 0~1
      -- UI å±‚é…ç½®
      ui = {
        float = {
          border   = "rounded",
          width    = 0.8,
          height   = 0.8,
          row      = 0.5,
          col      = 0.5,
          title    = " ğŸ¤– æ™ºè°± glm-4-flash ",
          title_pos= "center",
        },
        split = {
          direction = "vertical",      -- vertical|horizontal
          size      = 0.4,
        },
      },
      -- å·¥å…·é“¾é»˜è®¤å¼€å¯é¡¹
      tools = {
        WordTranslate = { enable = true },
        CodeExplain   = { enable = true },
        Translate     = { enable = true },
        TestCode      = { enable = true },
        OptimCompare  = { enable = true, diff_mode = true },
        UserInfo      = { enable = true },
        CommitMsg     = { enable = true },
        DocString     = { enable = true },
        Ask           = { enable = true, inline_assistant = true },
        AttachToChat  = { enable = true, inline_assistant = true },
      },
      -- æµå¼è¾“å‡ºè§£æï¼ˆå®˜æ–¹é»˜è®¤å³å¯ï¼‰
      streaming_handler = nil,
      parse_handler     = nil,
    })
  end,
}