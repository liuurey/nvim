-- æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜ lazy statsï¼Œé¿å…é‡å¤è®¡ç®—
local cache = {
  stats = nil,
  stats_time = 0,
  startup_ready = false, -- æ ‡è®°å¯åŠ¨æ—¶é—´æ˜¯å¦å·²ç»å‡†å¤‡å¥½
}

local function get_lazy_stats()
  local current_time = vim.loop.hrtime()
  -- ç¼“å­˜ 100msï¼Œå‡å°‘é‡å¤è®¡ç®—
  if not cache.stats or (current_time - cache.stats_time) > 100000000 then
    cache.stats = require("lazy").stats()
    cache.stats_time = current_time
  end
  return cache.stats
end

-- ç»Ÿä¸€çš„ footer ç”Ÿæˆå‡½æ•°
local function generate_footer()
  local stats = get_lazy_stats()
  local ms = stats.startuptime
  
  -- å¦‚æœå¯åŠ¨æ—¶é—´ä¸º 0 ä¸”è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œæ˜¾ç¤ºç­‰å¾…ä¿¡æ¯
  if ms == 0 and not cache.startup_ready then
    return string.format("âš¡ SANINS [SECTIONS] loaded %d/%d plugins (calculating...)", 
      stats.loaded, stats.count)
  end
  
  -- æ­£å¸¸æ˜¾ç¤ºå¯åŠ¨æ—¶é—´
  local formatted_ms = math.floor(ms * 100 + 0.5) / 100
  return string.format("âš¡ SANINS [SECTIONS] loaded %d/%d plugins in %sms", 
    stats.loaded, stats.count, formatted_ms)
end

return {
  "folke/snacks.nvim",
  priority = 1000,
  lazy = false,
  ---@type snacks.Config
  opts = function()
    return {
      -- SANINS ä¸ªæ€§åŒ–é…ç½®
      bigfile = { enabled = true },
      dashboard = {
        enabled = true,
        sections = {
          -- Header åˆ†åŒº
          {
            section = "header",
            text = [[
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„ â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„â–ˆâ–ˆ   â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„  â•‘
    â•‘  â–ˆâ–ˆâ–“       â–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–“   â–“ â–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ â–ˆâ–ˆâ–“â–“   â–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–“ â•‘
    â•‘  â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“ â•‘
    â•‘       â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–“   â–“â–“â–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–“     â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–“ â•‘
    â•‘  â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“ â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“ â–“â–ˆâ–ˆâ–“ â•‘
    â•‘            âŸ¨âŸ¨âŸ¨ Advanced Sections Layout âŸ©âŸ©âŸ©             â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ]],
            align = "center",
            padding = 1,
          },
          
          -- æ’ä»¶ç»Ÿè®¡ä¿¡æ¯ï¼ˆä½¿ç”¨ä¼˜åŒ–çš„ç¼“å­˜å‡½æ•°ï¼‰
          {
            text = function()
              return generate_footer()
            end,
            align = "center",
            padding = 1,
          },
          
          -- åŠŸèƒ½æŒ‰é”®åˆ†åŒºï¼ˆå·¦ä¾§ï¼‰
          {
            pane = 1,
            title = "ğŸš€ Quick Actions",
            padding = 1,
          },
          { pane = 1, icon = "ğŸ” ", title = "Find File", desc = "Search files", action = ":lua Snacks.dashboard.pick('files')", key = "f" },
          { pane = 1, icon = "ğŸ“ ", title = "New File", desc = "Create new", action = ":ene | startinsert", key = "n" },
          { pane = 1, icon = "ğŸ” ", title = "Find Text", desc = "Search text", action = ":lua Snacks.dashboard.pick('live_grep')", key = "g" },
          { pane = 1, icon = "âš™ï¸ ", title = "Config", desc = "Edit config", action = ":lua Snacks.dashboard.pick('files', {cwd = vim.fn.stdpath('config')})", key = "c" },
          
          -- å·¥å…·åˆ†åŒºï¼ˆå³ä¾§ï¼‰
          {
            pane = 2,
            title = "ğŸ”§ Development Tools",
            padding = 1,
          },
          { pane = 2, icon = "ğŸš€ ", title = "Lazy Manager", desc = "Plugin manager", action = ":Lazy", key = "l" },
          { pane = 2, icon = "ğŸ©º ", title = "Health Check", desc = "System health", action = function()
            -- å®‰å…¨åœ°æ‰§è¡Œå¥åº·æ£€æŸ¥ï¼Œé¿å… dashboard å…³é—­æ—¶çš„ autocmd é”™è¯¯
            vim.schedule(function()
              -- å…ˆå…³é—­ dashboardï¼Œå»¶è¿Ÿæ‰§è¡Œ checkhealth
              if vim.bo.filetype == 'snacks_dashboard' then
                local current_win = vim.api.nvim_get_current_win()
                -- ä½¿ç”¨æ›´å®‰å…¨çš„å…³é—­æ–¹å¼
                pcall(function()
                  vim.api.nvim_win_close(current_win, true)
                end)
                vim.defer_fn(function()
                  vim.cmd('checkhealth')
                end, 50)
              else
                vim.cmd('checkhealth')
              end
            end)
          end, key = "h" },
          { pane = 2, icon = "ğŸ”§ ", title = "Mason Tools", desc = "LSP manager", action = ":Mason", key = "m" },
          { pane = 2, icon = "ğŸŒ³ ", title = "TreeSitter", desc = "Parser info", action = ":TSInstallInfo", key = "t" },
          
          -- Recent Files åˆ†åŒº
          {
            pane = 2,
            title = "ğŸ“ Recent Files",
            section = "recent_files",
            indent = 2,
            padding = 1,
            limit = 5,
          },
          
          -- é€€å‡ºæŒ‰é”®
          {
            text = "Press q to quit",
            align = "center",
            padding = 1,
            hl = "Comment",
          },
        },
      },
      explorer = { enabled = true },
      indent = { enabled = true },
      input = { enabled = true },
      picker = { enabled = true },
      notifier = { enabled = true },
      quickfile = { enabled = true },
      scope = { enabled = true },
      scroll = { enabled = true },
      statuscolumn = { enabled = true },
      words = { enabled = true },
      image = { enabled = true }, -- å¯ç”¨å›¾åƒæ˜¾ç¤ºåŠŸèƒ½
    }
  end,
  
  config = function(_, opts)
    local ok, snacks = pcall(require, "snacks")
    if not ok then
      vim.notify("Failed to load snacks.nvim", vim.log.levels.ERROR)
      return
    end
    
    snacks.setup(opts)
    
    -- ç›‘å¬ LazyVimStarted äº‹ä»¶æ¥æ›´æ–°å¯åŠ¨æ—¶é—´
    vim.api.nvim_create_autocmd("User", {
      pattern = "LazyVimStarted",
      group = vim.api.nvim_create_augroup("SaninsStartupTime", { clear = true }),
      callback = function()
        cache.startup_ready = true
        cache.stats = nil  -- æ¸…ç©ºç¼“å­˜ä»¥è·å–æœ€æ–°çš„ startuptime
        
        -- å¦‚æœå½“å‰åœ¨ dashboard ä¸­ï¼Œåˆ·æ–°æ˜¾ç¤º
        if vim.bo.filetype == 'snacks_dashboard' then
          vim.schedule(function()
            snacks.dashboard()
          end)
        end
      end,
    })
    
    -- ä¼˜åŒ–çš„å¯åŠ¨æ—¶dashboardæ˜¾ç¤º
    vim.api.nvim_create_autocmd("VimEnter", {
      group = vim.api.nvim_create_augroup("SaninsDashboard", { clear = true }),
      callback = function()
        -- æ›´å‡†ç¡®çš„å¯åŠ¨æ£€æŸ¥ï¼šæ— å‚æ•°ä¸”å½“å‰bufferä¸ºç©º
        if vim.fn.argc() == 0 and vim.api.nvim_buf_get_name(0) == "" and vim.api.nvim_buf_line_count(0) <= 1 then
          local line = vim.api.nvim_buf_get_lines(0, 0, -1, false)[1] or ""
          if line == "" then
            snacks.dashboard()
          end
        end
      end,
    })
    
    -- ç¼“å­˜æ¸…ç†ï¼ˆå¯é€‰ï¼Œç”¨äºé•¿æ—¶é—´è¿è¡Œçš„sessionï¼‰
    vim.api.nvim_create_autocmd("VimLeavePre", {
      group = vim.api.nvim_create_augroup("SaninsCleanup", { clear = true }),
      callback = function()
        cache.stats = nil
        cache.startup_ready = false
      end,
    })
  end,
}