-- Krabby å¯åŠ¨ç”»é¢é…ç½®
-- æä¾›ç»ˆç«¯ ASCII è‰ºæœ¯å¯åŠ¨ç”»é¢ï¼Œå¯ä¸ç°æœ‰ dashboard å…±å­˜

return {
  -- è¿™ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ’ä»¶ï¼Œè€Œæ˜¯ä¸€ä¸ªé…ç½®æ¨¡å—
  -- ç”¨äºç®¡ç† Krabby å¯åŠ¨ç”»é¢çš„é›†æˆ
  
  -- åˆ›å»ºå¯åŠ¨æ—¶æ˜¾ç¤º Krabby çš„è‡ªåŠ¨å‘½ä»¤
  init = function()
    -- æ£€æŸ¥ Krabby æ˜¯å¦å·²å®‰è£…
    local function has_krabby()
      return vim.fn.executable('krabby') == 1
    end
    
    -- åˆ›å»º Krabby æ˜¾ç¤ºå‡½æ•°
    local function show_krabby()
      if not has_krabby() then
        vim.notify("ğŸ¦€ Krabby æœªå®‰è£…ã€‚è¯·è¿è¡Œ: cargo install krabby", vim.log.levels.WARN)
        return
      end
      
      -- åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²åŒºæ˜¾ç¤º Krabby
      local buf = vim.api.nvim_create_buf(false, true)
      vim.api.nvim_set_current_buf(buf)
      
      -- è®¾ç½®ç¼“å†²åŒºé€‰é¡¹
      vim.bo[buf].modifiable = false
      vim.bo[buf].readonly = true
      vim.bo[buf].buftype = 'nofile'
      vim.bo[buf].bufhidden = 'wipe'
      vim.bo[buf].swapfile = false
      
      -- è¿è¡Œ Krabby å¹¶æ•è·è¾“å‡º
      local output = vim.fn.system('krabby')
      local lines = vim.split(output, '\n')
      
      -- ç§»é™¤æœ€åçš„ç©ºè¡Œ
      if lines[#lines] == '' then
        table.remove(lines)
      end
      
      -- è®¾ç½®ç¼“å†²åŒºå†…å®¹
      vim.bo[buf].modifiable = true
      vim.api.nvim_buf_set_lines(buf, 0, -1, false, lines)
      vim.bo[buf].modifiable = false
      
      -- å±…ä¸­æ˜¾ç¤º
      local win_height = vim.api.nvim_win_get_height(0)
      local content_height = #lines
      local padding = math.max(0, math.floor((win_height - content_height) / 2))
      
      if padding > 0 then
        local empty_lines = {}
        for i = 1, padding do
          table.insert(empty_lines, "")
        end
        vim.bo[buf].modifiable = true
        vim.api.nvim_buf_set_lines(buf, 0, 0, false, empty_lines)
        vim.bo[buf].modifiable = false
      end
      
      -- è®¾ç½®é”®ä½æ˜ å°„å¿«é€Ÿé€€å‡º
      vim.keymap.set('n', 'q', function()
        vim.cmd('enew')
      end, { buffer = buf, desc = "é€€å‡º Krabby ç”»é¢" })
      
      vim.keymap.set('n', '<CR>', function()
        vim.cmd('enew')
      end, { buffer = buf, desc = "é€€å‡º Krabby ç”»é¢" })
      
      vim.keymap.set('n', '<Esc>', function()
        vim.cmd('enew')
      end, { buffer = buf, desc = "é€€å‡º Krabby ç”»é¢" })
      
      -- ç¦ç”¨è¡Œå·å’Œå…¶ä»– UI å…ƒç´ 
      vim.wo.number = false
      vim.wo.relativenumber = false
      vim.wo.signcolumn = 'no'
      vim.wo.foldcolumn = '0'
      vim.wo.colorcolumn = ''
      vim.wo.cursorline = false
      vim.wo.cursorcolumn = false
      
      -- è®¾ç½®é«˜äº®ï¼ˆå¦‚æœéœ€è¦ï¼‰
      vim.cmd('hi clear CursorLine')
    end
    
    -- åˆ›å»ºç”¨æˆ·å‘½ä»¤
    vim.api.nvim_create_user_command('Krabby', show_krabby, {
      desc = 'ğŸ¦€ æ˜¾ç¤º Krabby å¯åŠ¨ç”»é¢'
    })
    
    vim.api.nvim_create_user_command('KrabbyStart', show_krabby, {
      desc = 'ğŸ¦€ æ˜¾ç¤º Krabby å¯åŠ¨ç”»é¢'
    })
    
    -- æ£€æŸ¥æ˜¯å¦åº”è¯¥åœ¨å¯åŠ¨æ—¶æ˜¾ç¤º Krabby
    vim.api.nvim_create_autocmd('VimEnter', {
      group = vim.api.nvim_create_augroup('KrabbyStart', { clear = true }),
      callback = function()
        -- åªæœ‰åœ¨æ²¡æœ‰æ–‡ä»¶å‚æ•°æ—¶æ‰æ˜¾ç¤º
        if vim.fn.argc() == 0 and vim.fn.line2byte('$') == -1 then
          -- æ£€æŸ¥ç”¨æˆ·é…ç½®æ˜¯å¦å¯ç”¨äº† Krabby å¯åŠ¨
          if vim.g.krabby_on_startup then
            vim.defer_fn(show_krabby, 100)
          end
        end
      end,
    })
    
    -- åˆ›å»ºåˆ‡æ¢å‡½æ•°
    local function toggle_startup_dashboard()
      if vim.g.krabby_on_startup then
        vim.g.krabby_on_startup = false
        vim.notify("ğŸ¦€ Krabby å¯åŠ¨ç”»é¢å·²ç¦ç”¨ï¼Œå°†ä½¿ç”¨é»˜è®¤ dashboard", vim.log.levels.INFO)
      else
        vim.g.krabby_on_startup = true
        vim.notify("ğŸ¦€ Krabby å¯åŠ¨ç”»é¢å·²å¯ç”¨", vim.log.levels.INFO)
      end
    end
    
    vim.api.nvim_create_user_command('KrabbyToggle', toggle_startup_dashboard, {
      desc = 'ğŸ¦€ åˆ‡æ¢ Krabby å¯åŠ¨ç”»é¢'
    })
    
    -- é«˜çº§é…ç½®é€‰é¡¹
    vim.api.nvim_create_user_command('KrabbyConfig', function()
      print("ğŸ¦€ Krabby é…ç½®é€‰é¡¹:")
      print("â€¢ :Krabby - æ‰‹åŠ¨æ˜¾ç¤º Krabby ç”»é¢")
      print("â€¢ :KrabbyToggle - åˆ‡æ¢å¯åŠ¨æ—¶æ˜¾ç¤º")
      print("â€¢ :KrabbyInstall - å®‰è£…æŒ‡å—")
      print("â€¢ vim.g.krabby_on_startup = true/false - è®¾ç½®å¯åŠ¨æ˜¾ç¤º")
      print("â€¢ å½“å‰çŠ¶æ€: " .. (vim.g.krabby_on_startup and "å¯ç”¨" or "ç¦ç”¨"))
    end, {
      desc = 'ğŸ¦€ æ˜¾ç¤º Krabby é…ç½®ä¿¡æ¯'
    })
    
    -- å®‰è£…æŒ‡å—
    vim.api.nvim_create_user_command('KrabbyInstall', function()
      print("ğŸ¦€ Krabby å®‰è£…æŒ‡å—:")
      print("1. ä½¿ç”¨ Cargo å®‰è£…: cargo install krabby")
      print("2. æˆ–ä» GitHub ä¸‹è½½: https://github.com/yannjor/krabby/releases")
      print("3. ç¡®ä¿ krabby åœ¨ PATH ä¸­")
      print("4. è¿è¡Œ :Krabby æµ‹è¯•")
      print("5. ä½¿ç”¨ :KrabbyToggle å¯ç”¨å¯åŠ¨ç”»é¢")
    end, {
      desc = 'ğŸ¦€ æ˜¾ç¤º Krabby å®‰è£…æŒ‡å—'
    })
  end
}